## 消息队列的应用场景

- 异步处理

- 模块之间的解耦

- 高并发系统的削峰





利用操作系统的缓存原理达到高性能，可分区，分布式，有不同语言的客户端





## kafka的高性能、高可靠

![image-20200704190907521](/Users/fanxudong/Library/Application Support/typora-user-images/image-20200704190907521.png)



> 生产者消息分区。Kafka的消息组织方式实际上为一个3级结构，topic、分区、消息。对同一个topic下的数据进行分区，不同的分区可以放置到不同的机器节点上，消息的读写以分区为单位进行。分区可提升集群的可伸缩性、进行负载均衡，提高吞吐量。（分而治之）
>
> 消息压缩，通过生产者端一定的CPU消耗，来减少Broker端的磁盘空间消耗和网络传输带宽。可以在生产者和Broker端指定压缩策略。
>
> Cache Filesystem Cache PageCache缓存：使用操作系统页缓存来存储数据。
>
> 顺序读写磁盘，加快消息从磁盘写入和读区： 由于现代的操作系统提供了预读和写技术，磁盘的顺序写大多数情况下比随机写内存还要快。
>
> Zero-copy 零拷技术加快消费：服务端处理消费消息的逻辑是：文件 -- PageCache -- 应用程序内存 --Socket缓冲区。使用零拷贝技术时，直接把PageCache 中把数据复制到 Socket 缓冲区。由于不用把数据复制到用户内存空间，DMA 控制器可以直接完成数据复制，不需要 CPU 参与，速度更快。
>
> Batching of Messages 批量量处理，批量发送和处理消息。合并小的请求，然后以流的方式进行交互，直顶网络上限。客户端发送请求时，kafka先把消息存入缓存，然后异步批量发送。
>
> Pull 拉模式 使用拉模式进行消息的获取消费，与消费端处理能力相符。



> 怎么不丢失消息、不重复发送消息、不重复消费消息：数据备份、生产消息幂等、事务。对已提交的数据做有限度的持久化保存。







## kafka的分区策略

轮询策略

随机策略

按消息键保序策略



## 压缩算法（吞吐量和压缩比 的比较）

GZIP

zstd 压缩（建议）

## 参考

[15 | Kafka如何实现高性能IO？](https://time.geekbang.org/column/article/126493)

[Kafka核心技术与实战](https://time.geekbang.org/column/intro/100029201)