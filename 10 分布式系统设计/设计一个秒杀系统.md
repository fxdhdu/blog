



先来假设一下我们的业务场景，我们要卖多少件商品，并预估秒杀时的流量。

场景一：要卖100件商品，预估流量为10万人。 可以直接在数据库扣减库存和创建订单了。

场景二：要卖10万件商品。  无法在数据库中扣减库存，在redis中扣减。



然后，看设计这么个秒杀系统需要关注哪些问题、细节。高并发(缓存雪崩、缓存击穿、缓存穿透)、超卖、恶意请求（机器请求）、链接暴露、数据库压力。

- 高并发(缓存雪崩、缓存击穿、缓存穿透)
- 如何避免超卖？redis中利用原子操作decr扣减库存，返回值小于0扣减失败。数据库扣减库存的话where加上大于0的条件，避免扣为负值。
- 恶意请求（机器请求、脚本请求）
- 链接暴露
- 数据库压力：扣减库存、创建订单



设计思路，服务单一职责、秒杀链接加盐（URL动态化）、redis集群（主从同步、读写分离、哨兵、持久化）、资源静态化（cdn）、按钮控制、限流（物理控制、前端限流、后端限流）&降级&熔断&隔离、库存预热（redis）、削峰填谷（MQ）、nginx负载均衡（流量机）、风控、事务、数据库（索引、链接池、分库）、分布式事务（2PC、3PC）



- 服务单一职责 （高并发原则：拆分）


- 秒杀链接加盐（URL动态化）


- redis集群（主从同步读写分离、哨兵、持久化）（高并发原则：缓存/源站/分布式缓存）


- 资源静态化（cdn）：（高并发原则：缓存/广域网）
  把秒杀商品详情页做成静态页面。把商品详情、商品价格等参数、评论评价等信息全部放在这个静态页面里，然后把这个静态页面上传到CDN上预热（CDN是内容分发网络，可以简单理解成互联网上的巨大的缓存，用于存放静态页面、图片、视频等，可以显著提高访问速度），用CDN扛流量，这样大量的商品详情页的访问请求就不用访问自己的网站（源站）。这样既可以提高访问速度，也没有给网站增加压力，同时也减少了网站带宽压力。

- 按钮控制

  秒杀时，按钮点击后置灰，防止重复提交。

- 限流（物理控制、前端限流、后端限流）

- 降级（高可用原则：降级） 大促时保障用户能下单、能支付的核心要求，并保障数据最终一致性。可同步调用改异步。

- 熔断 

- 隔离
  - 业务隔离：CDN预热、库存预热（redis）
  - 部署隔离：从网络入口层分流，单独部署网关
  - 数据隔离：redis、数据库单独部署

- 削峰填谷（MQ）：下单流程（高并发原则：消息队列）


- nginx负载均衡（流量机）网关/代理：分段放行、请求拦截。对下单接口按userID限流，和整体限流。加一层防火墙或高防服务，预防DDos等分布式网络攻击。


- 风控：在网关层把羊毛党请求据掉。


- 事务


- 数据库（索引、链接池、分库）：


- 分布式事务（2PC、3PC）
- 网络：秒杀前要和网络运营商、CDN服务商提前申请带宽。



## 参考

[阿里面试官问我：如何设计秒杀系统？我给出接近满分的回答](https://aobing.blog.csdn.net/article/details/103105780)

[面试了十个应届生九个都是秒杀系统，你确定你们那是秒杀？](https://aobing.blog.csdn.net/article/details/107833096)

[秒杀系统设计 亿级用户](https://mp.weixin.qq.com/s/Qh-wjqBKsXHVS57UzD3MYQ)