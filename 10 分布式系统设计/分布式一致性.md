一定要看，这个书写的非常好。

浏览加了注解的《架构解密-从分布式到微服务》的第三章。



## 什么是一致性

在传统IT时代，一致性通常指强一致性。在互联网时代，一致性指分布式服务化系统之间的弱一致性，包括应用系统的一致性和数据的一致性。



## 一致性的具体问题

1、下订单和扣库存案例中出现的超卖和少卖问题。

**2、同步调用超时，导致调用方不知道被调用方的实际处理情况。**

**3、异步回调超时。**

4、掉单。一个系统中存在的请求，另外一个系统不存在。

5、系统间状态不一致。两个系统间都存在请求，但是请求状态不一致。

**6、缓存和数据库不一致。（CAC缓存CMDB云服务实例）**

**7、本地缓存节点间不一致。（本地系统配置缓存）**

8、缓存数据结构不一致。



## 解决一致性问题的模式和思路

### 酸碱平衡理论

#### 1、ACID

关系型数据库具有ACID特性，支持强一致性，数据库本身不会出现不一致。通常通过MVCC来实现。

#### 2、CAP理论 （帽子理论-Eric Brewer-2000）

分布式系统的CAP原理，包含3个要素。C为Consistency表示一致性。在分布式系统中的所有数据备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。A为Availability，表示可用性，好的响应性能。完全的可用性指的是在任何故障模型下，服务都会在有限的时间内处理完成并进行响应。P为Partition tolerance，分区容忍性。即尽管网络上有部分消息丢失但系统仍然可以继续工作。CAP原理证明，任何分布式系统只可同时满足以上两点，无法三者兼顾。通常分布式系统都需要满足分区容忍性，必须在一致性和可用性之间进行权衡。

#### 3、BASE 准则（eBay-2008）

BASE思想用来解决CAP提出的分布式系统的一致性和可用性不可兼得的问题（CA不可兼得）。通过牺牲强一致性获得可用性，通过达到最终一致性来尽量满足业务的绝大多数需求。

BASE模型包含3个元素。BA为Basically Available，表示基本可用。S为Soft State，表示软状态，意思为状态可以在一段时间内不同步。E为Eventually Consistent，表示最终一致，即在一定的时间窗口内，最终数据达成一致即可。

软状态是实现BASE思想的方法，基本可用和最终一致是目标。

数据库领域中，BASE思想的主要实现是对业务数据进行拆分，让不同的数据分布在不同的机器上，以提升系统的可用性。主要做法是1、按功能划分数据库。2、分片。拆分后用最终一致性的思路来实现高性能的分布式事务



ACID、CAP、BASE是理论和思想，解决一致性问题的三条实践经验：1、向上扩展并使用关系型数据库。2、关系型数据库水平伸缩和分片。3、实现最终一致性。



## 一致性算法

Paxos算法（ZooKeeper使用Zab算法）

Raft算法（Go语言实现的Etcd）：把分布式集群的一致性问题抽象成一个特殊的状态机模型--Replicated State Machines。集群中的每台服务器通过日志文件来持久化保存客户端发出的指令序列，供本地状态机顺序执行。只需要保证每台服务器上日志文件的一致性，就能保证整个集群里状态机的一致性。



### 分布式一致性协议

DTS（分布式事务处理模型）

TX协议 XA协议

XA事务

X/OpenDTP事务模型（业界首个分布式事务标准规范）

Java分布式事务编程接口规范：JTA

#### 1、两阶段提交模型（2PC）

#### 2、三阶段提交

#### 3、TCC



