[TOC]

## 锁宏观上分类

### 乐观锁

乐观锁（ Optimistic Locking）是一种思想。相对悲观锁而言，乐观锁假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回用户错误的信息，让用户决定如何去做。假设多用户并发的事务在处理时不会彼此互相影响，各事务能够在不产生锁的情况下处理各自影响的那部分数据。在提交数据更新之前，每个事务会先检查在该事务读取数据后，有没有其他事务又修改了该数据。如果其他事务有更新的话，正在提交的事务会进行回滚。

#### 乐观锁的具体实现细节

主要就是两个步骤：冲突检测和数据更新。 如果没有冲突就更新数据。

其实现方式比较典型的就是Compare and Swap(CAS)。

version

Select for update

#### CAS

#### ABA问题

### 悲观锁
悲观并发控制主要用于数据争用激烈的环境，以及发生并发冲突时使用锁保护数据的成本要低于回滚事务的成本的环境中。



| 乐观锁   | 悲观锁   |
| -------- | -------- |
| 偏斜锁   | 重量级锁 |
| 轻量级锁 |          |
| 自旋锁   |          |



## 偏斜锁

## 自旋锁

线程不进入阻塞状态，减少用户态与内核态的切换。

等待时间

## 轻量级锁

## 重量级锁

锁膨胀、降级

## 死锁

## 活锁

## 参考
[深入理解乐观锁与悲观锁](http://www.hollischuang.com/archives/934)
http://www.importnew.com/20472.html

## 应用
1. 本系统加锁 + 外部系统 ---》同一个数据库
2. ActivitiOptimisticLockingException
3. MySQL乐观锁
4. 系统自己实现乐观锁来代替hazlcaset
5. ![](/Users/fanxudong/IdeaProjects/blog/4 Java/assert/E4F604F6-06A3-4CA5-832C-FE467FAF4BA9.png)