[TOC]



## TCP 和 UDP 有哪些区别？

| TCP                                                          | UDP                        |
| ------------------------------------------------------------ | -------------------------- |
| 面向连接 （需要维护连接，复杂）                              | 无连接（支持广播，简单）   |
| 通信前，通过三次握手建立连接。即在客户端和服务端建立一定的数据结构，维护双方的交互状态。结束时，四次握手。 |                            |
| 数据无差错、不丢失、不重复、有序                             | 不保证不丢失，不保证有序。 |
| 字节流                                                       | 数据报                     |
| 拥塞控制                                                     | （勇往直前）               |
| 有状态（包头中有状态位）                                     | 无状态                     |



## UDP

UDP包 -》 目标机器 -〉MAC匹配 -》IP匹配 -〉确认UDP协议 -》 应用端口

![img](./asset/2c9a109f3be308dea901004a5a3b4c84.png)



### UDP的特点

- 使用场景
  - 需要资源少（不用维护连接），在网络情况比较好的内网，或者对于丢包不敏感的应用 （DHCP、TFTP）
  - 不需要一对一沟通，建立连接，而是可以广播的应用 （IGMP、VXLAN）
  - 需要处理速度快，时延低（没有拥塞控制，应用可自己实现），可以容忍少数丢包，但是要求即便网络拥塞，也毫不退缩，一往无前的时候。



### UDP使用的五个例子

1. 网页或者 APP 的访问

   QUIC（全称 Quick UDP Internet Connections，快速 UDP 互联网连接）：降低网络通信的延迟，提供更好的用户互动体验。自己实现快速连接建立、减少重传时延，自适应拥塞控制

2. 流媒体的协议

   RTMP：基于TCP

   基于 UDP 实现自己的视频传输协议。

3. 实时游戏

   游戏有一个特点，就是实时性比较高。采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

4. IoT 物联网

5. 移动通信领域



## TUP

通过算法解决丢包、乱序、重传，拥塞等网络问题。

序号：解决乱序问题

确认序号：解决丢包问题，没收到就重传

状态位：（维护连接）

​	SYN ：发起一个连接

​	ACK ：回复

​	RST ：重新连接

​	FIN：结束连接等

窗口大小：流量控制、拥塞控制

![img](./asset/642947c94d6682a042ad981bfba39fbf.png)

### TCP 3次握手

为什么不是2次握手？为什么不是4次握手？双方消息有去有回，基本就可以了，多次无用。

TCP序号确认：起始序号随时间变化，一个32位计数器每4秒加一

![img](./asset/c067fe62f49e8152368c7be9d91adc08.png)

一开始，客户端和服务端都处于 CLOSED 状态。

先是服务端主动监听某个端口，处于 LISTEN 状态。

然后客户端主动发起连接 SYN，之后处于 SYN-SENT 状态。

服务端收到发起的连接，返回 SYN，并且 ACK 客户端的 SYN，之后处于 SYN-RCVD 状态。

客户端收到服务端发送的 SYN 和 ACK 之后，发送 ACK 的 ACK，之后处于 ESTABLISHED 状态，因为它一发一收成功了。

服务端收到 ACK 的 ACK 之后，处于 ESTABLISHED 状态，因为它也一发一收了。

### TCP 四次挥手





### TCP拥塞控制，为什么这么设计

拥塞窗口 cwnd，防止把网络塞满。



  

## 思考题

1. 如果让你实现一个类似于tcp的协议，为了保证可靠性你会怎么实现。
2. 为什么TCP可以保证顺序的传输，如果ACK丢失了，TCP进行怎样的修复操作



## 参考

[第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”](https://time.geekbang.org/column/article/8924?utm_source=pinpaizhuanqu&utm_medium=geektime&utm_campaign=guanwang&utm_term=guanwang&utm_content=0511)

