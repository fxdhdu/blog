​		

​		需要在千万级数据中，每5分钟统计一次，近一个小时的数据中有多少任务成功，多少任务失败，并计算成功率。将统计和计算结果写入另一个表中。

​		千万级数据时，influxDB执行 count(distinct) 时超时。

**关键词：** 分区表、范围分区表、索引

从一条sql的执行说起。

[TOC]

# 客户端

- DBeaver、pgadmin、navicat


- jdbc：JDBC是目前最为通用的java和数据库的交互技术。常见的开源框架都构建在JDBC之上。


- psql、mysql命令（客户端工具）


# Server层

## 连接器

长连接    

session闲置超时时间

## 查询缓存

缓存失效

更新语句执行时，表上所有查询缓存都会失效，所以查询缓存只适用于静态表，必需系统配置。

Mysql 8.0 没有查询缓存功能。

## 分析器

- 词法分析

拆解字符串，识别出关键字，表名，字段等。

- 语法分析

校验sql语法，提示错误的语法。

## 优化器

选择索引

JOIN时选择表的连接顺序

## 执行器

权限校验

调用引擎的接口

如果没有索引，则会全表扫描。

慢查询日志中记录扫描行数



索引失效，什么情况下会失效

binlog（归档日志）

执行计算操作，函数

# 存储引擎

磁盘读取、写入，为server层提供数据。

Mysql实现索引。当有索引时，进行树搜索。

提供事务相关接口给执行器

## InnoDB

- redo log（重做日志）：
  - 物理日志
  - 记录更新语句
  - crash-safe：数据库异常重启时，不会丢失之前提交的更新
  - 两阶段提交（跨系统维持数据逻辑一致性）：用于保持binlog和redo log逻辑上的一致性，防止通过日志恢复数据或扩容时，数据不一致。
- [通过索引组织表，表根据主键顺序以索引的形式存放的。主键索引树的叶子节点是数据，而普通索引树的叶子节点是主键值。](https://time.geekbang.org/column/article/69236)
  - B+树结构
  - 自增主键（ID），主键自动创建唯一索引。
  - 业务字段做主键

![](/Users/fanxudong/IdeaProjects/blog/1 数据库/assert/dcda101051f28502bd5c4402b292e38d.png)

- [执行count(*)时，做的操作](https://time.geekbang.org/column/article/72775)



## MyISAM

不支持事务


# PostgreSQL支持的分区类型	

- Range Partitioning
  The table is partitioned into “ranges” defined by a key column or set of columns, with no overlap between the ranges of values assigned to different partitions. For example, one might partition by date ranges, or by ranges of identifiers for particular business objects.

范围分区表：在创建时，就要指定各个分区的范围和分区名称。或者在创建完主分区表后，手动创建分表。当插入的数据不在任何分区时会报错。也可以新增日期字段，在存入数据时，通过时间戳计算出当前日期，从而改用分区表。

```
CREATE TABLE measurement (
    city_id         int not null,
    logdate         date not null,
    peaktemp        int,
    unitsales       int
) PARTITION BY RANGE (logdate);
```

```
CREATE TABLE measurement_y2006m02 PARTITION OF measurement
    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01');
```

- List Partitioning
  The table is partitioned by explicitly listing which key values appear in each partition.

- Hash Partitioning
  The table is partitioned by specifying a modulus and a remainder for each partition. Each partition will hold the rows for which the hash value of the partition key divided by the specified modulus will produce the specified remainder.



# 参考

[MySQL性能优化实践](https://mp.weixin.qq.com/s/ZxSgqtIFM3hD6ohZdIDR5w)
[MySQL实战45讲](https://time.geekbang.org/column/article/72775)





临时表

查看 MySQL 服务器运行的状态值

`show status`

Queries 查询次数
Threadsconnected 线程连接数
Threadsrunning 线程运行数

查看 PostgreSQL 服务器运行的状态值


MySQL中获取需要优化的 SQL 语句
`show processlist`
通过state字段判断

PostgreSQL中获取需要优化的 SQL 语句
`SELECT datname,pid,state,query FROM pg_stat_activity`

SQL执行计划
在select查询语句前加上`explain`

为排序、分组字段建立索引



**主从复制技术实现读写分离** https://blog.csdn.net/aaronthon/article/details/81714528





